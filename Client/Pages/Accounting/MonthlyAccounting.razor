@using LifeHelper.Shared.Models.LIFF

@inject IHttpClientFactory clientFactory

<Loading IsLoading="@(model == null || isLoading)"></Loading>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />

@if (model != null)
{
    <div class="flex flex-row justify-between">
        <label @onclick="()=>QueryAccountingAsync(model.PreAccountingPeriodUtc)" class="pl-3 cursor-pointer material-symbols-outlined text-3xl text-red-800">
            @(model.PreAccountingPeriodUtc != null ? "arrow_back_ios" : "")
        </label>
        <label class="font-bold text-red-800 text-3xl font-bold">
            @CurrentUtcDate.AddHours(8).ToString("yyyy 年 MM 月")
        </label>
        <label @onclick="()=>QueryAccountingAsync(model.NextAccountingPeriodUtc)" class="pr-3 cursor-pointer material-symbols-outlined text-3xl text-red-800">
            @(model.NextAccountingPeriodUtc != null ? "arrow_forward_ios" : "")
        </label>
    </div>

    <IncomeDetail Income="@model.Income" TotalIncome="@model.TotalIncome"></IncomeDetail>

    <OutlayReport OutlayReportModel="@model.ReportDetails" TotalOutlay="@model.TotalOutlay"></OutlayReport>

    <OutlayDetail Outlay="@model.Outlay"></OutlayDetail>

}

@code {
    public MonthlyAccountingVm? model { get; set; } = null;

    private bool isLoading { get; set; }

    private HttpClient httpClient => clientFactory.CreateClient(nameof(HttpClient));

    private DateTime CurrentUtcDate { get; set; } = DateTime.UtcNow;

    protected override async Task OnInitializedAsync()
    {
        await QueryAccountingAsync(CurrentUtcDate);
    }

    private async Task QueryAccountingAsync(DateTime? date)
    {
        isLoading = date != null;

        if (date == null)
            return;

        var repMsg = await httpClient.GetAsync($"AccountingBook/MonthlyAccounting/{date.Value.Ticks}");

        model = await repMsg.Content.ReadFromJsonAsync<MonthlyAccountingVm?>();

        isLoading = false;

        if (model == null)
            return;

        CurrentUtcDate = model.AccountingPeriodUtc;
    }

}
