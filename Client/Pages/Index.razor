@page "/"

@using LifeHelper.Shared.Models.LIFF
@using LifeHelper.Client.Service

@inject HttpClient Http
@inject LIFFService LIFF

<PageTitle>小記帳</PageTitle>

@if (monthlyAccounting == null)
    return;

<MonthlyAccounting model="@monthlyAccounting"></MonthlyAccounting>


@code {
    private MonthlyAccountingVm? monthlyAccounting;
    private string? IDToken;

    protected override async Task OnInitializedAsync()
    {
        var LiffId = await Http.GetStringAsync("LIFF/GetLIFFId");

        await LIFF.InitAsync(LiffId);

        if (!await LIFF.IsLoggedInAsync())
        {
            await LIFF.LoginAsync();
            return;
        }

        IDToken = await LIFF.GetIDTokenAsync();

        Http.DefaultRequestHeaders.Add("Authorization", $"Bearer {IDToken}");

        var repMsg = await Http.GetAsync("AccountingBook/MonthlyAccounting");

        if (!repMsg.IsSuccessStatusCode && repMsg.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            await LIFF.LogoutAsync();
            await LIFF.LoginAsync();
            return;
        }

        monthlyAccounting = await repMsg.Content.ReadFromJsonAsync<MonthlyAccountingVm?>();

        await base.OnInitializedAsync();

    }
}